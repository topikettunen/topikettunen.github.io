<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Creating Comfy FreeBSD Jails Using Standard Tools - Topi Kettunen</title>
    <link rel="canonical" href="https://kettunen.io/post/standard-freebsd-jails/">
    <meta name="description" content="Fragmented essay on computer science and art">
    
    <link rel="stylesheet" href="/css/style.css">
    
  </head>
  <body>
    <header>
  <h1><a href="https://kettunen.io/">Topi Kettunen</a></h1>
  <div id="header-bar">
    <div id="navigation">
      <a href="/">Index</a> |
      <a href="/bio">Bio</a>
    </div>
    <div id="social">
      <a href="https://github.com/topikettunen">GitHub</a> | 
      <a href="https://linkedin.com/in/topikettunen">LinkedIn</a> |
      <a href="mailto:topi@kettunen.io">Mail</a> |
      <a href="/index.xml">RSS</a>
    </div>
  </div>
</header>

    
<main>
  <article>
    <div id="post-title">
      <h1>Creating Comfy FreeBSD Jails Using Standard Tools</h1>
      
      <time>17 January, 2021</time>
      
    </div>
    <div>
      <p><a href="https://www.docker.com/">Docker</a> has stormed into software development in
recent years. While the concepts behind it are powerful and useful, similar
tools have been used in systems for decades. FreeBSD&rsquo;s
<a href="https://www.freebsd.org/doc/handbook/jails.html">jails</a> in one of those tools
which build upon even older <code>chroot(2)</code> To put it shortly, with these tools, you
can make a safe environment separated from the rest of the system.</p>
<p>Jails in FreeBSD is by no means a new tool (introduced in 4.X), but for a reason
or another, I haven&rsquo;t used them that often, which is a shame since they are so
powerful. So I wanted to explore this concept in a concise and summarized
manner.</p>
<h2 id="templates">Templates</h2>
<p>ZFS datasets are a great way of creating templates for jails since, after the
template creation, you can easily create new jails with <code>zfs clone</code> or <code>zfs send/receive</code>. Typically people tend to divide jails to complete and service
jails, where the former usually resembles a real FreeBSD system, and the latter
is often dedicated to applications/services. I&rsquo;ll cover complete jails for now.</p>
<p>The creation of templates starts with creating a dataset for your jail and
template. Here I&rsquo;ll make a new dataset for the base installation of FreeBSD
12.2.</p>
<pre><code>$ sudo zfs create -o mountpoint=/vm zroot/vm
$ sudo zfs create zroot/vm/tmpl
$ sudo zfs create zroot/vm/tmpl/12.2
</code></pre><p>After that, fetch the base installation itself:</p>
<pre><code>$ fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/12.2-RELEASE/base.txz
# Fetch all the necessary stuff for your template, e.g. lib32 if needed
$ sudo tar -xJvpf base.txz -C /vm/tmpl/12.2
</code></pre><p>After that you should write a minimum viable <code>/etc/rc.conf</code> for the template:</p>
<pre><code>$ sudo emacs /vm/tmpl/12.2/etc/rc.conf
</code></pre><blockquote>
<p><strong>Note</strong>: Refer to <code>rc.conf(5)</code>.</p>
</blockquote>
<pre><code># Start or stop services
sendmail_enable=&quot;NO&quot;
sendmail_submit_enable=&quot;NO&quot;
sendmail_outbound_enable=&quot;NO&quot;
sendmail_msp_queue_enable=&quot;NO&quot;
syslogd_flags=&quot;-ss&quot;
cron_flags=&quot;-J 60&quot;
</code></pre><p>You can also disable some unnecessary jobs for jails:</p>
<pre><code>$ sudo emacs /vm/tmpl/12.2/etc/periodic.conf
</code></pre><blockquote>
<p><strong>Note</strong>: Refer to <code>periodic.conf(5)</code>.</p>
</blockquote>
<pre><code># No output for successful script runs.
daily_show_success=&quot;NO&quot;
weekly_show_success=&quot;NO&quot;
monthly_show_success=&quot;NO&quot;
security_show_success=&quot;NO&quot;
   
# Output to log files which are rotated by default.
daily_output=&quot;/var/log/daily.log&quot;
daily_status_security_output=&quot;/var/log/daily.log&quot;
weekly_output=&quot;/var/log/weekly.log&quot;
weekly_status_security_output=&quot;/var/log/weekly.log&quot;
monthly_output=&quot;/var/log/monthly.log&quot;
monthly_status_security_output=&quot;/var/log/monthly.log&quot;
   
# No need for those without sendmail
daily_clean_hoststat_enable=&quot;NO&quot;
daily_status_mail_rejects_enable=&quot;NO&quot;
daily_status_mailq_enable=&quot;NO&quot;
daily_queuerun_enable=&quot;NO&quot;
   
# Host does those
daily_status_disks_enable=&quot;NO&quot;
daily_status_zfs_zpool_list_enable=&quot;NO&quot;
daily_status_network_enable=&quot;NO&quot;
daily_status_uptime_enable=&quot;NO&quot;
daily_ntpd_leapfile_enable=&quot;NO&quot;
weekly_locate_enable=&quot;NO&quot;
weekly_whatis_enable=&quot;NO&quot;
security_status_chksetuid_enable=&quot;NO&quot;
security_status_neggrpperm_enable=&quot;NO&quot;
security_status_chkuid0_enable=&quot;NO&quot;
security_status_ipfwdenied_enable=&quot;NO&quot;
security_status_ipfdenied_enable=&quot;NO&quot;
security_status_ipfwlimit_enable=&quot;NO&quot;
security_status_ipf6denied_enable=&quot;NO&quot;
security_status_tcpwrap_enable=&quot;NO&quot;
</code></pre><p>You also might want to enable ports in your jail:</p>
<pre><code>$ sudo mkdir /vm/tmpl/12.2/usr/ports
$ sudo mkdir -p /vm/tmpl/12.2/var/ports/{distfiles,packages}
$ sudo emacs /vm/tmpl/12.2/etc/make.conf
</code></pre><pre><code>WRKDIRPREFIX = /var/ports
DISTDIR = /var/ports/distfiles
PACKAGES = /var/ports/packages
</code></pre><p>Apply system updates to the template:</p>
<pre><code>$ sudo freebsd-update -b /vm/tmpl/12.2 fetch install
</code></pre><p>Lastly, take a snapshot:</p>
<pre><code>$ sudo zfs snapshot zroot/vm/tmpl/12.2@complete
</code></pre><p>This creates a snapshot of <code>zroot/vm/tmpl/12.2</code> named <code>complete</code>. You can then check your current snapshots with:</p>
<pre><code>$ sudo zfs list -t snapshot
</code></pre><h2 id="creating-jails-from-the-template">Creating Jails from the Template</h2>
<p>Now you should be able to create a new jail based on that snapshot. You can do
it either with <code>zfs clone</code> or <code>zfs send/receive</code>:</p>
<blockquote>
<p><strong>Difference Between the Two</strong></p>
</blockquote>
<blockquote>
<p>&ldquo;A clone is a writable volume or file system whose initial contents are the
same as the dataset from which it was created. As with snapshots, creating a
clone is nearly instantaneous and initially consumes no additional disk
space. In addition, you can snapshot a clone.&rdquo; [1]</p>
</blockquote>
<blockquote>
<p>&ldquo;The zfs send command creates a stream representation of a snapshot that is
written to standard output. By default, a full stream is generated. You can
redirect the output to a file or to a different system. The zfs receive
command creates a snapshot whose contents are specified in the stream that is
provided on standard input. If a full stream is received, a new file system is
created as well. You can send ZFS snapshot data and receive ZFS snapshot data
and file systems with these commands. See the examples in the next section.&rdquo;
[2]</p>
</blockquote>
<pre><code>$ sudo zfs clone zroot/vm/tmpl/12.2@complete zroot/vm/jail1

# OR

$ sudo sh -c &quot;zfs send zroot/vm/tmpl/12.2@complete | zfs receive zroot/vm/jail1&quot;
</code></pre><h2 id="jail-configurations">Jail Configurations</h2>
<blockquote>
<p><strong>Note</strong>: These configurations is for very bare-bones jail, e.g. without any
mounts or advanced networking. Further configurations are discussed in future posts.</p>
</blockquote>
<pre><code># /etc/rc.conf

cloned_interfaces=&quot;lo0&quot;

# PF is used for NAT and port forwarding.
pf_enable=&quot;YES&quot;
pflog_enable=&quot;YES&quot;

jail_enable=&quot;YES&quot;
jail_list=&quot;jail1&quot;
</code></pre><blockquote>
<p><strong>Note</strong>: Refer to <code>jail.conf(5)</code>.</p>
</blockquote>
<pre><code># /etc/jail.conf

exec.start = &quot;/bin/sh /etc/rc&quot;;
exec.stop = &quot;/bin/sh /etc/rc.shutdown&quot;;
exec.clean;
mount.devfs;

host.hostname = $name;
path = &quot;/vm/$name&quot;;
exec.consolelog = &quot;/var/log/jail_${name}_console.log&quot;;
exec.prestart = &quot;cp /etc/resolv.conf $path/etc&quot;;
exec.poststop = &quot;rm $path/etc/resolv.conf&quot;;

jail1 {
        ip4.addr = &quot;lo0|127.1.1.1/32&quot;;
        ip6.addr = &quot;lo0|fd00:1:1:1::1/64&quot;;
        allow.chflags;
        allow.raw_sockets;
}
</code></pre><pre><code># /etc/hosts

...

127.1.1.1 jail1
fd00:1:1:1::1 jail1
</code></pre><h2 id="jail-management">Jail Management</h2>
<p>Start/stop all jails.</p>
<pre><code>$ sudo service jail start
</code></pre><p>Start/stop a specific jail(s).</p>
<pre><code>$ sudo service jail start jail1
</code></pre><p>Log in to jail.</p>
<pre><code>$ sudo jexec jail1
</code></pre><p>Exec a command on a jail.</p>
<pre><code>$ sudo jexec jail1 uname -a
FreeBSD jail1 12.2-RELEASE FreeBSD 12.2-RELEASE r366954 GENERIC  amd64
</code></pre><p>List running jails.</p>
<pre><code>$ jls
   JID  IP Address      Hostname                      Path
     3  127.1.1.1       jail1                         /vm/jail1
</code></pre><p>So that&rsquo;s how you can spin up a simple restricted environment on your FreeBSD
system. There are still lots of things to cover in this topic, e.g., in-depth
networking and configurations. But I think those deserve their own posts. So see
you soon!</p>
<h2 id="notes">Notes</h2>
<p>[1] Overview of ZFS Clones: <a href="https://docs.oracle.com/cd/E19253-01/819-5461/gbcxz/index.html">https://docs.oracle.com/cd/E19253-01/819-5461/gbcxz/index.html</a></p>
<p>[2] Sending and Receiving ZFS Data: <a href="https://docs.oracle.com/cd/E18752_01/html/819-5461/gbchx.html">https://docs.oracle.com/cd/E18752_01/html/819-5461/gbchx.html</a></p>
<h2 id="references">References</h2>
<ol>
<li><a href="https://www.freebsd.org/doc/handbook/jails.html">FreeBSD Jails</a></li>
</ol>

    </div>
  </article>
</main>

<section class="comments">
  <p>
    Have a comment on one of my posts? Start a discussion by sending an email to <a href="mailto:topi@kettunen.io">topi@kettunen.io</a>.
  </p>
</section>



    <footer>
  <p>&copy; 2021 Topi Kettunen - Unless otherwise noted, these posts are made available under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.</p>
</footer>

  </body>
</html>
